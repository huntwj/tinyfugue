name: CI

on:
  push:
    branches: [ 'main' ]
  pull_request:
    branches: [ '**' ]

jobs:
  # ── Rust build & test (primary — Phase 15 cutover) ───────────────────────
  build:
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        include:
          # Default build: no optional scripting engines.
          - cargo_flags: ""
            apt_packages: ""
          # Lua 5.4 embedding via mlua.
          - cargo_flags: "--features lua"
            apt_packages: "lua5.4 liblua5.4-dev"
          # Python embedding via pyo3.
          - cargo_flags: "--features python"
            apt_packages: "python3-dev"

    steps:
      - uses: actions/checkout@v4

      - name: Install extra packages
        if: matrix.apt_packages != ''
        run: sudo apt-get install -y ${{ matrix.apt_packages }}

      - name: Build
        run: cargo build ${{ matrix.cargo_flags }}

      - name: Test
        run: cargo test ${{ matrix.cargo_flags }}

  clippy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Clippy
        run: cargo clippy -- -D warnings

  # ── Legacy C build (archived) ─────────────────────────────────────────────
  # These jobs built the original C binary.  Kept for reference; disabled
  # following the Phase 15 cutover to the Rust binary.
  build-c:
    if: false
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.10', '3.12', '3.13']
        opts:
          - "--enable-lua"
          - "--enable-python"
          - "--disable-widechar"

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      - name: Install packages on Linux
        run: sudo apt-get install lua5.4 liblua5.4-dev libpcre3-dev
      - name: Configure
        run: ./configure --enable-version --enable-symlink --enable-atcp --enable-gmcp --enable-option102 ${{ matrix.opts }}
      - name: Build
        run: make
      - name: Install
        run: make install

  build-c-macos:
    if: false
    runs-on: macos-latest

    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.12', '3.13']
        opts:
          - "--enable-python"
          - "--disable-widechar"

    steps:
      - uses: actions/checkout@v4
      - name: Install packages on MacOS
        run: |
          brew install lua pcre2 python@${{ matrix.python-version }}
          echo "/usr/local/opt/python@${{ matrix.python-version }}/bin" >> $GITHUB_PATH
      - name: Configure
        run: ./configure --enable-version --enable-symlink --enable-atcp --enable-gmcp --enable-option102 ${{ matrix.opts }}
      - name: Build
        run: make
      - name: Install
        run: make install
